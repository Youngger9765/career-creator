name: ðŸ§¹ Artifact Registry Cleanup

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨ 2 é»ž
  workflow_dispatch:
    inputs:
      keep_images:
        description: 'ä¿ç•™æ˜ åƒæ•¸é‡'
        required: false
        default: '2'
        type: choice
        options: ['1', '2', '3', '5']

env:
  PROJECT_ID: career-creator-472207
  REGION: us
  FRONTEND_IMAGE: gcr.io/career-creator-472207/career-creator-frontend
  BACKEND_IMAGE: gcr.io/career-creator-472207/career-creator-backend

jobs:
  cleanup:
    name: ðŸ—‘ï¸ Clean Docker Images
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ðŸ“Š Check Repository Status
        id: check
        run: |
          echo "ðŸ” æª¢æŸ¥ Repository ç‹€æ…‹..."

          SIZE=$(gcloud artifacts repositories describe gcr.io \
            --location=$REGION \
            --project=$PROJECT_ID \
            --format="get(sizeBytes)" 2>/dev/null || echo "0")

          SIZE_MB=$(echo "scale=0; $SIZE / 1024 / 1024" | bc)
          echo "Repository å¤§å°: ${SIZE_MB}MB"
          echo "size=${SIZE_MB}" >> $GITHUB_OUTPUT

      - name: ðŸ§¹ Clean Frontend Images
        run: |
          KEEP_COUNT=${{ github.event.inputs.keep_images || '2' }}
          echo "ðŸ“Œ æ¸…ç† Frontend æ˜ åƒï¼Œä¿ç•™æœ€æ–° $KEEP_COUNT å€‹"

          # ç²å–æ‰€æœ‰ tagsï¼ŒæŒ‰æ™‚é–“æŽ’åº (æœ€æ–°åœ¨å‰)
          TAGS=$(gcloud container images list-tags $FRONTEND_IMAGE \
            --format="get(digest)" \
            --sort-by="~timestamp" 2>/dev/null || echo "")

          if [ ! -z "$TAGS" ]; then
            TOTAL=$(echo "$TAGS" | wc -l)
            echo "  ðŸ“Š ç¸½å…± $TOTAL å€‹æ˜ åƒ"

            if [ $TOTAL -gt $KEEP_COUNT ]; then
              TO_DELETE=$(echo "$TAGS" | tail -n +$((KEEP_COUNT + 1)))
              DELETE_COUNT=$(echo "$TO_DELETE" | wc -l)

              echo "  ðŸ—‘ï¸ åˆªé™¤ $DELETE_COUNT å€‹èˆŠæ˜ åƒ..."

              for DIGEST in $TO_DELETE; do
                IMAGE_REF="${FRONTEND_IMAGE}@${DIGEST}"
                echo "    åˆªé™¤: $IMAGE_REF"
                if gcloud container images delete "$IMAGE_REF" \
                  --force-delete-tags --quiet 2>/dev/null; then
                  echo "    âœ… æˆåŠŸåˆªé™¤"
                else
                  echo "    âš ï¸ åˆªé™¤å¤±æ•—"
                fi
              done
            else
              echo "  âœ… ç„¡éœ€æ¸…ç†ï¼Œåªæœ‰ $TOTAL å€‹æ˜ åƒ"
            fi
          else
            echo "  âš ï¸ ç„¡æ³•ç²å–æ˜ åƒåˆ—è¡¨"
          fi

      - name: ðŸ§¹ Clean Backend Images
        run: |
          KEEP_COUNT=${{ github.event.inputs.keep_images || '2' }}
          echo "ðŸ“Œ æ¸…ç† Backend æ˜ åƒï¼Œä¿ç•™æœ€æ–° $KEEP_COUNT å€‹"

          # ç²å–æ‰€æœ‰ tagsï¼ŒæŒ‰æ™‚é–“æŽ’åº (æœ€æ–°åœ¨å‰)
          TAGS=$(gcloud container images list-tags $BACKEND_IMAGE \
            --format="get(digest)" \
            --sort-by="~timestamp" 2>/dev/null || echo "")

          if [ ! -z "$TAGS" ]; then
            TOTAL=$(echo "$TAGS" | wc -l)
            echo "  ðŸ“Š ç¸½å…± $TOTAL å€‹æ˜ åƒ"

            if [ $TOTAL -gt $KEEP_COUNT ]; then
              TO_DELETE=$(echo "$TAGS" | tail -n +$((KEEP_COUNT + 1)))
              DELETE_COUNT=$(echo "$TO_DELETE" | wc -l)

              echo "  ðŸ—‘ï¸ åˆªé™¤ $DELETE_COUNT å€‹èˆŠæ˜ åƒ..."

              for DIGEST in $TO_DELETE; do
                IMAGE_REF="${BACKEND_IMAGE}@${DIGEST}"
                echo "    åˆªé™¤: $IMAGE_REF"
                if gcloud container images delete "$IMAGE_REF" \
                  --force-delete-tags --quiet 2>/dev/null; then
                  echo "    âœ… æˆåŠŸåˆªé™¤"
                else
                  echo "    âš ï¸ åˆªé™¤å¤±æ•—"
                fi
              done
            else
              echo "  âœ… ç„¡éœ€æ¸…ç†ï¼Œåªæœ‰ $TOTAL å€‹æ˜ åƒ"
            fi
          else
            echo "  âš ï¸ ç„¡æ³•ç²å–æ˜ åƒåˆ—è¡¨"
          fi

      - name: ðŸ“Š Final Report
        run: |
          echo "## ðŸ§¹ æ¸…ç†å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FINAL_SIZE=$(gcloud artifacts repositories describe gcr.io \
            --location=$REGION \
            --project=$PROJECT_ID \
            --format="get(sizeBytes)" 2>/dev/null || echo "0")

          FINAL_SIZE_MB=$(echo "scale=0; $FINAL_SIZE / 1024 / 1024" | bc)

          echo "- æ¸…ç†å‰å¤§å°: ${{ steps.check.outputs.size }}MB" >> $GITHUB_STEP_SUMMARY
          echo "- æ¸…ç†å¾Œå¤§å°: ${FINAL_SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
          echo "- ä¿ç•™æ˜ åƒæ•¸: ${{ github.event.inputs.keep_images || '2' }}" >> $GITHUB_STEP_SUMMARY
          echo "- åŸ·è¡Œæ™‚é–“: $(date)" >> $GITHUB_STEP_SUMMARY

          # å‰©é¤˜æ˜ åƒçµ±è¨ˆ
          FRONTEND_COUNT=$(gcloud container images list-tags $FRONTEND_IMAGE --format="value(digest)" | wc -l)
          BACKEND_COUNT=$(gcloud container images list-tags $BACKEND_IMAGE --format="value(digest)" | wc -l)

          echo "- Frontend å‰©é¤˜: ${FRONTEND_COUNT} å€‹æ˜ åƒ" >> $GITHUB_STEP_SUMMARY
          echo "- Backend å‰©é¤˜: ${BACKEND_COUNT} å€‹æ˜ åƒ" >> $GITHUB_STEP_SUMMARY
