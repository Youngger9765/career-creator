name: Seed Demo Consultation Records

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'seed'
        options:
          - seed
          - rollback

jobs:
  seed-demo-data:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure environment variables
        run: |
          cd backend
          if [ "${{ inputs.environment }}" == "staging" ]; then
            echo "DATABASE_URL=${{ secrets.DATABASE_POOLER_URL_STAGING }}" >> .env
            echo "DIRECT_DATABASE_URL=${{ secrets.DATABASE_POOLER_URL_STAGING }}" >> .env
            echo "GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME_STAGING }}" >> .env
            echo "Environment: STAGING"
          else
            echo "DATABASE_URL=${{ secrets.DATABASE_POOLER_URL_PRODUCTION }}" >> .env
            echo "DIRECT_DATABASE_URL=${{ secrets.DATABASE_POOLER_URL_PRODUCTION }}" >> .env
            echo "GCS_BUCKET_NAME=${{ secrets.GCS_BUCKET_NAME_PRODUCTION }}" >> .env
            echo "Environment: PRODUCTION"
          fi
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env

      - name: Seed demo consultation records
        run: |
          cd backend
          if [ "${{ inputs.action }}" == "rollback" ]; then
            echo "ðŸ—‘ï¸  Rolling back demo data..."
            python scripts/seed_demo_consultation_records.py \
              --env ${{ inputs.environment }} \
              --rollback
          else
            echo "ðŸŒ± Seeding demo data..."
            # Production requires manual confirmation - auto-confirm in CI
            if [ "${{ inputs.environment }}" == "production" ]; then
              echo "CONFIRM" | python scripts/seed_demo_consultation_records.py \
                --env ${{ inputs.environment }}
            else
              python scripts/seed_demo_consultation_records.py \
                --env ${{ inputs.environment }}
            fi
          fi

      - name: Verify results
        if: inputs.action == 'seed'
        run: |
          cd backend
          python scripts/verify_demo_data.py

      - name: Summary
        if: always()
        run: |
          echo "### Seed Demo Data - Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action**: ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.action }}" == "seed" ]; then
            echo "âœ… Demo consultation records created for Dr. Sarah Chen" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps**:" >> $GITHUB_STEP_SUMMARY
            echo "1. Login as \`demo.counselor@example.com\` / \`demo123\`" >> $GITHUB_STEP_SUMMARY
            echo "2. Navigate to consultation records page" >> $GITHUB_STEP_SUMMARY
            echo "3. Verify 6-9 records are visible" >> $GITHUB_STEP_SUMMARY
            echo "4. (Optional) Upload demo screenshots to GCS" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ—‘ï¸  Demo data has been rolled back" >> $GITHUB_STEP_SUMMARY
          fi
