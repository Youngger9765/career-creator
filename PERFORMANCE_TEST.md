# 智能輪詢 + 樂觀更新 性能測試指南

## 目前狀態

✅ 智能輪詢機制已實現
✅ 樂觀更新功能已整合
✅ 閒置偵測已啟用 (30秒無操作停止輪詢)
✅ 4秒輪詢間隔
✅ 前端：<http://localhost:3007>
✅ 後端：<http://localhost:8000>

## 測試步驟

### 1. 基本功能測試

1. 打開瀏覽器到 <http://localhost:3007>
2. 創建一個房間
3. 進入諮詢模式
4. 觀察同步狀態指示器：
   - 🟢 "同步中" = 正在輪詢
   - 🔴 "待機" = 閒置停止
   - 🔵 "X 待處理" = 有樂觀更新

### 2. 多分頁測試 (成本驗證)

1. 開 3-5 個分頁到同一房間
2. 在不同分頁操作卡牌
3. 觀察：
   - 每個分頁每4秒一次請求
   - 無操作30秒後自動停止
   - 操作時重新啟動輪詢

### 3. 網路開發者工具監控

1. 打開 F12 > Network 分頁
2. 過濾 "Fetch/XHR"
3. 觀察請求頻率：
   - 活躍時：每4秒一次 `/api/card-events/room/{roomId}/latest`
   - 閒置時：無請求
   - 操作時：立即觸發輪詢

### 4. 樂觀更新測試

1. 拖拽卡牌到畫布
2. 觀察：
   - 卡牌立即出現（樂觀更新）
   - 同步狀態顯示 "待處理"
   - 4秒內確認同步成功

## 預期成本影響

### 單用戶場景

- 活躍 20分鐘：300 requests (20min ÷ 4s)
- 每日 10 sessions：3,000 requests
- 月總計：~90,000 requests
- **預估增加成本：$0.50-1.00/月**

### 智能優化效果

- 閒置自動停止：節省 ~60% 請求
- 實際請求：~35,000/月
- **實際增加成本：$0.20-0.50/月**

## 驗證重點

### ✅ 功能驗證

- [ ] 卡牌操作有立即反饋
- [ ] 4秒內同步到其他分頁
- [ ] 30秒無操作停止輪詢
- [ ] 操作時重新啟動輪詢

### ✅ 性能驗證

- [ ] 單分頁：4秒間隔請求
- [ ] 多分頁：每個獨立間隔
- [ ] 閒置：完全停止請求
- [ ] 無明顯延遲感

### ✅ 成本驗證

- [ ] 請求數量可控
- [ ] 閒置優化生效
- [ ] 無無效輪詢

## 問題排查

### 如果同步指示器一直顯示 "待機"

- 檢查後端是否運行 (localhost:8000)
- 檢查 console 錯誤訊息

### 如果請求過於頻繁

- 確認 syncInterval = 4000ms
- 確認 smartPolling = true

### 如果樂觀更新失效

- 確認 optimisticUpdates = true
- 檢查 pendingOperations 狀態

## 下一步測試

成功驗證後，可以：

1. 調整輪詢間隔 (3-5秒)
2. 測試更複雜的操作場景
3. 部署到 staging 環境測試

---
## 結論

測試完成後回報結果，我們可以進一步優化
