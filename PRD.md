# 線上牌卡系統 PRD - 專案管理紀錄

## 產品概述

**產品名稱**：線上牌卡諮詢系統
**目標用戶**：職涯諮詢師與其來訪者
**核心價值**：將實體牌卡數位化，支援遠距諮詢與資料累積

## 🎯 三階段開發計畫

### 第1個月：MVP 核心功能

**目標**：建立可運作的原型系統

#### 必須完成 ✅

1. **諮詢師註冊登入** ✅ 已完成
2. **創建與管理房間** ✅ 已完成
3. **牌卡基本操作（翻牌、拖曳）** ✅ 已完成
4. **分享房間連結** ✅ 已完成
5. **即時同步機制** ✅ 已完成 (Supabase Realtime)
6. **三種牌卡七大玩法** ✅ 已完成

#### 未完成 ❌

1. **牌卡狀態持久化到後端資料庫** ❌ 待實作
2. **諮詢記錄儲存到資料庫** ❌ 待實作
3. **訪客流程優化** ⚠️ 部分完成

### 第2個月：資料持久化與諮詢功能

**目標**：完整的諮詢記錄與數據累積

#### 必須完成

1. **牌卡狀態持久化** 🚧
   - Event Sourcing 架構
   - 所有牌卡操作記錄到 card_events 表
   - 房間狀態恢復功能

2. **諮詢師記錄功能** 🚧
   - 諮詢過程筆記區
   - 語音/文字記錄
   - 標記重要時刻

3. **諮詢歷史管理**
   - 完整諮詢記錄查看
   - 歷史資料匯出
   - 諮詢報告生成

4. **客戶管理強化**
   - 客戶檔案完善
   - 諮詢進度追蹤
   - 多次諮詢關聯

### 第3個月：AI 輔助與進階功能

**目標**：智慧化輔助與規模化

#### 計畫功能

1. **AI 諮詢輔助**
   - 智慧牌卡推薦
   - 諮詢洞察分析
   - 自動生成諮詢摘要

2. **班級管理系統**
   - 多人同時諮詢
   - 群組管理功能
   - 批量報告生成

3. **用戶自定義內容**
   - 自訂牌卡內容
   - 自訂玩法規則
   - 個人化牌組管理

> **「多副牌卡」定義說明**：指在同一規則下，讓用戶可以自定義牌卡內容（如自創職業卡、自訂價值觀卡等）。MVP階段僅提供官方預設牌卡內容。
>
> **範圍調整**：三種牌卡玩法規則會全部實現，但每種規則只提供官方版本的牌卡內容，用戶自定義牌卡功能留待後續開發。

## 用戶系統架構

### 簡化架構（MVP採用）

```text
諮詢師
├── 需要註冊（Email + 密碼）
├── 可創建多個房間
└── 可查看歷史紀錄

來訪者
├── 免註冊
├── 透過連結進入
└── 輸入暱稱即可使用
```

## 🚀 目前實作狀態（2025-09-30）

### ✅ 已完成功能

1. **用戶系統** ✅
   - 諮詢師註冊/登入 (JWT)
   - Demo 帳號測試
   - 權限管理

2. **房間系統** ✅
   - 房間 CRUD 操作
   - QR Code 分享
   - 7天自動過期機制

3. **即時同步** ✅ (第2個月需求提前完成)
   - Supabase Realtime Broadcast
   - 游標同步顯示
   - 卡片移動同步
   - 卡片正反面同步

4. **遊戲引擎** ✅
   - 三大牌組完整實作
   - 七種玩法全部運作
   - 通用規則引擎

5. **客戶管理 (CRM)** ✅ (第2個月需求提前完成)
   - 來訪者基本資訊紀錄
   - 諮詢歷程追蹤
   - 時間軸檢視

### ❌ 待實作功能

1. **資料持久化**
   - 牌卡狀態儲存到資料庫
   - Event Sourcing 實作
   - 房間狀態恢復

2. **諮詢記錄**
   - 諮詢師筆記功能
   - 重要時刻標記
   - 諮詢報告生成

3. **生產環境優化**
   - 訪客流程完善
   - 錯誤處理強化
   - 效能優化

## 頁面架構

### URL結構（詳細需求版）

```text
# 基本頁面
/                           # 首頁 / 登入畫面
/login                      # 諮詢師登入
/register                   # 諮詢師註冊
/dashboard                  # 諮詢列表 / 房間管理

# 房間系統
/rooms/create              # 新增房間
/room/[roomId]             # 房間（諮詢詳情）
/room/[roomId]?visitor=true&name=小明    # 來訪者進入

# 未來擴展（目前不實作）
/sessions                  # 諮詢列表（等同 /dashboard）
/sessions/<session_id>     # 諮詢詳情（等同 /room/[roomId]）
/sessions/<session_id>/decks/<deck_id>/plays/<play_id>  # 遊戲階層
```

### 網域架構（目標架構 vs 目前實作）

**目標架構：**

```text
第一層：諮詢師 (https://careercreator.tw/counselor1)
第二層：空間 (https://careercreator.tw/counselor1/room1)
第三層：牌卡 (https://careercreator.tw/counselor1/room1/card1)
第四層：玩法 (https://careercreator.tw/counselor1/room1/card1/play1)
```

**目前 MVP 實作：**

```text
# 簡化為單層結構，所有諮詢師共用同一個域名
/room/[roomId]  # 直接房間 ID，內建權限控制
```

**實作差異說明：**

- 目前採用簡化架構，不區分諮詢師子域名
- 權限透過登入狀態和房間創建者來控制
- 牌卡和玩法整合在房間內，不獨立分層

## 房間管理邏輯

### 房間生命週期

1. **創建**：諮詢師創建，獲得唯一ID
2. **分享**：生成短連結 + QR Code
3. **活躍**：有人在房間內操作
4. **閒置**：無人操作但仍可訪問
5. **過期**：超過有效期（預設7天）

### 權限管理

```javascript
諮詢師（房間創建者）
- 所有操作權限
- 可清空畫面
- 可結束房間

來訪者（透過連結加入）
- 可操作牌卡
- 可查看內容
- 無法刪除房間
```

## 牌卡操作功能

### 🎯 三大模式九種玩法（完整架構）

> **技術決策說明**：採用**三層通用規則引擎架構**，實現3大模式共9種玩法。參考iGaming行業最佳實踐，新玩法上線只需數天而非數週。

## 🎮 整體架構層級圖

```text
遊戲系統
│
├─ 模式選擇 (Mode)
│   ├─ 玩法選擇 (Gameplay)
│   │   ├─ 牌卡配置 (Auto)
│   │   └─ 畫布布局 (Auto)
│   └─ ...
```

## 🃏 三大模式詳細架構

### 1. 職游旅人卡模式

```text
職游旅人卡
├─ 六大性格分析
│   ├─ 6張解釋卡 (R/I/A/S/E/C)
│   └─ 三欄畫布 (喜歡/中立/討厭)
└─ 職業收藏家
    ├─ 100張職業卡
    └─ 單一收藏區 (最多15張精選)
```

#### 1.1 六大性格分析

**牌組構成**: 解釋卡6張 + 職業卡100張
**操作區域**: 三列分類區
**分類標準**: 喜歡 / 中立 / 討厭

**遊戲流程：**

1. **準備階段**: 諮詢師展示6張解釋卡，說明六大性格類型
2. **探索階段**: 來訪者從100張職業卡中選擇並分類
3. **討論階段**: 針對「喜歡」和「討厭」的職業深入對話
4. **總結階段**: 分析性格偏好與職涯方向的關聯

**區域限制：**

- 喜歡區：最多20張
- 中立區：無限制
- 討厭區：最多20張

#### 1.2 職業收藏家

**諮詢目標**: 幫助來訪者建立職業探索清單
**操作邏輯**: 從100張職業卡中精選最感興趣的15張
**畫布設計**: 單一收藏區，類似收藏夾概念

### 2. 職能盤點卡模式

```text
職能盤點卡
├─ 優劣勢分析
│   ├─ 單一職能卡組
│   └─ 雙區畫布 (優勢/劣勢)
├─ 成長計畫
│   ├─ 雙卡組 (A職能+B技能)
│   └─ 三區畫布 (A區+B區+文字註記)
└─ 職位拆解
    ├─ 單一職能卡組
    └─ 大型畫布 (自由排列+截圖上傳)
```

#### 2.1 優劣勢分析（原有）

- 左側：堆疊牌組
- 右側：兩個區域（優勢5張/劣勢5張）
- 拖曳牌卡到對應區域
- 顯示計數器（如：3/5）

#### 2.2 成長計畫

**諮詢目標**: 制定職涯發展路徑和技能提升計畫
**牌卡配置**: A組職能卡 + B組技能卡
**畫布設計**: 三區域（現有職能/目標技能/行動計畫）

#### 2.3 職位拆解

**諮詢目標**: 深度分析特定職位所需的各項能力
**操作邏輯**: 自由排列職能卡，模擬職位能力地圖
**特殊功能**: 支援截圖上傳，可與實際JD對照

### 3. 價值導航卡模式

```text
價值導航卡
├─ 價值觀排序
│   ├─ 價值卡組 (36張核心價值)
│   └─ 分層畫布 (第1/2/3名+其他層級)
└─ 生活改造王
    ├─ 價值卡組 + 生活籌碼系統
    └─ 量表畫布 (0-100滿意度+籌碼分配)
```

#### 3.1 價值觀排序（原有）

- 左側：不同價值的牌組（36張核心價值卡）
- 右側：分層排序區（第1/2/3名 + 其他層級）
- 拖曳排序，每層限制數量
- 重點突出前三名

#### 3.2 生活改造王 🎯

**諮詢目標**: 生活滿意度評估與資源重新分配
**特殊機制**: **籌碼分配系統**（100點生活能量）
**畫布設計**: 價值滿意度量表 + 籌碼投資分配

**🎲 籌碼系統設計：**

- 總籌碼：100點「生活能量」
- 分配規則：依照重要程度分配到各價值領域
- 視覺呈現：籌碼數量 = 圓點大小或數字顯示
- 約束條件：總和必須等於100

**遊戲流程：**

1. **現況評估**: 標記各價值領域的滿意度 (0-100)
2. **理想分配**: 用100個籌碼分配到各領域
3. **差距分析**: 對比滿意度與投資分配
4. **改造計畫**: 找出需要調整的領域

**籌碼互動邏輯：**

- 點擊 [+] 增加該領域籌碼
- 點擊 [-] 減少該領域籌碼
- 即時顯示剩餘籌碼數量
- 總和超過100時警告提示
- 支援拖曳籌碼在領域間轉移

## 🚀 用戶旅程設計

```text
用戶進入 → 選擇模式 → 選擇玩法 → 系統自動配置 → 開始遊戲
         (職游/職能/價值)  (1-3種)    (牌卡+畫布)
```

## 🔑 關鍵設計原則

- **🎯 單一職責**: 每個玩法只負責一種特定的咨詢目標
- **🔄 自動配置**: 用戶選擇玩法後，系統自動配置牌卡和畫布
- **🎨 專屬設計**: 每個玩法都有獨特的視覺設計和交互方式
- **📱 一致體驗**: 所有玩法共享相同的基礎操作邏輯

### 基礎操作

1. **翻牌**：點擊切換正反面
2. **拖曳**：從牌組拖到放置區
3. **查看**：長按或雙擊查看詳情
4. **註記**：諮詢師可加註解

### 牌卡狀態（詳細需求）

- **正面**：顯示牌卡標題和圖片
- **反面**：顯示牌卡詳細描述
- **檢閱詳情**：彈出詳細資訊視窗
- **dropped**：已放置到目標區域

## 資料模型（簡化版）

### User（諮詢師）

```typescript
{
  id: string
  email: string
  name: string
  password: string  // 加密
}
```

### Room（房間）

```typescript
{
  id: string
  counselorId: string
  name: string
  status: 'active' | 'expired'
  shareLink: string
  expiresAt: Date
  createdAt: Date
}
```

### Visitor（來訪者）

```typescript
{
  roomId: string
  nickname: string
  joinedAt: Date
}
```

### CardAction（操作記錄）

```typescript
{
  id: string
  roomId: string
  userId: string
  action: 'flip' | 'move' | 'annotate'
  cardId: string
  timestamp: Date
  data: JSON
}
```

## 技術決策（MVP）

### 前端

- Next.js 14（手機優先）
- Tailwind CSS（快速開發）
- @dnd-kit（拖曳功能）
- Zustand（狀態管理）

### 後端

- FastAPI（Python 3.11+）
- PostgreSQL + SQLModel
- JWT 認證
- **Supabase Realtime（即時同步） ✅ 已實作**

### 即時同步架構 ✅ 已實作

- **Supabase Broadcast** - 低延遲即時通訊
- **遊戲狀態同步** - 卡片位置、選擇狀態即時更新
- **在線狀態顯示** - 即時顯示房間內參與者
- **文字輸入同步** - 支援多人協作編輯
- 詳細架構請參考 [同步架構文件](docs/SYNC_ARCHITECTURE.md)

### 部署

- GCP Cloud Run（前後端分離部署）
- PostgreSQL on Supabase
- GitHub Actions CI/CD

## 📊 開發時程追蹤

### 第1個月實際完成（2025-09-01 ~ 09-30）

#### Week 1 ✅

- 專案架設（Next.js + FastAPI）
- 資料庫設計（PostgreSQL + Supabase）
- 諮詢師註冊/登入系統

#### Week 2 ✅

- 房間 CRUD 系統
- QR Code 分享機制
- 訪客加入流程

#### Week 3 ✅

- 七大遊戲模式實作
- 拖曳功能（@dnd-kit）
- Supabase Realtime 同步

#### Week 4 ✅

- 客戶管理系統
- Staging 環境部署
- 同步功能測試與優化

### 第2個月計畫（2025-10-01 ~ 10-31）

#### Week 5-6

- 牌卡狀態持久化到資料庫
- Event Sourcing 架構實作
- 房間狀態恢復功能

#### Week 7-8

- 諮詢師筆記系統
- 諮詢報告生成
- 資料匯出功能

### 第3個月計畫（2025-11-01 ~ 11-30）

#### Week 9-10

- AI 諮詢輔助整合
- 智慧牌卡推薦

#### Week 11-12

- 班級管理系統
- 批量報告生成
- 用戶自定義內容

---

## 📝 版本紀錄

- **v4.0** (2025-09-30): 重構為專案管理文件，移除UI細節，新增三階段開發計畫
- **v3.0** (2025-09-29): 加入即時同步架構
- **v2.0** (2025-09-15): 完成遊戲引擎設計
- **v1.0** (2025-09-01): 初版 PRD
