# 線上牌卡系統 PRD

## 產品概述

**產品名稱**：線上牌卡諮詢系統
**目標用戶**：職涯諮詢師與其來訪者
**核心價值**：將實體牌卡數位化，支援遠距諮詢與資料累積

## MVP 範圍（第1個月）

### 核心功能

1. **諮詢師註冊登入**
2. **創建與管理房間**
3. **牌卡操作（翻牌、拖曳、註記）**
4. **分享房間連結**
5. **基礎資料儲存**

### 不包含（延後）

- 班級管理系統
- AI 功能
- 報告生成
- 多副牌卡（用戶自定義牌卡內容功能）

> **「多副牌卡」定義說明**：指在同一規則下，讓用戶可以自定義牌卡內容（如自創職業卡、自訂價值觀卡等）。MVP階段僅提供官方預設牌卡內容。

> **範圍調整**：三種牌卡玩法規則會全部實現，但每種規則只提供官方版本的牌卡內容，用戶自定義牌卡功能留待後續開發。

## 用戶系統架構

### 簡化架構（MVP採用）

```
諮詢師
├── 需要註冊（Email + 密碼）
├── 可創建多個房間
└── 可查看歷史紀錄

來訪者
├── 免註冊
├── 透過連結進入
└── 輸入暱稱即可使用
```

## User Flow

### 諮詢師流程

```
1. 註冊/登入
   ↓
2. 進入儀表板（房間列表）
   ↓
3. 創建新房間
   - 輸入房間名稱（如：張小明-職涯諮詢）
   - 設定有效期限（預設7天）
   ↓
4. 獲得分享連結/QR Code
   ↓
5. 分享給來訪者（LINE、Email等）
   ↓
6. 進入房間等待
   ↓
7. 引導來訪者操作牌卡
   - 翻牌查看
   - 拖曳排序
   - 添加註記
   ↓
8. 結束諮詢
   - 房間保持可訪問狀態
   - 可查看歷史記錄
```

### 來訪者流程

```
1. 收到連結/掃描QR Code
   ↓
2. 打開連結
   ↓
3. 輸入暱稱（無需註冊）
   ↓
4. 進入房間
   ↓
5. 操作牌卡
   - 查看牌卡
   - 翻牌
   - 拖曳選擇
   ↓
6. 完成諮詢
   - 可重複進入房間（有效期內）
```

## 頁面架構

### URL結構（詳細需求版）

```
# 基本頁面
/                           # 首頁 / 登入畫面
/login                      # 諮詢師登入
/register                   # 諮詢師註冊
/dashboard                  # 諮詢列表 / 房間管理

# 房間系統
/rooms/create              # 新增房間
/room/[roomId]             # 房間（諮詢詳情）
/room/[roomId]?visitor=true&name=小明    # 來訪者進入

# 未來擴展（目前不實作）
/sessions                  # 諮詢列表（等同 /dashboard）
/sessions/<session_id>     # 諮詢詳情（等同 /room/[roomId]）
/sessions/<session_id>/decks/<deck_id>/plays/<play_id>  # 遊戲階層
```

### 網域架構（目標架構 vs 目前實作）

**目標架構：**

```
第一層：諮詢師 (https://careercreator.tw/counselor1)
第二層：空間 (https://careercreator.tw/counselor1/room1)
第三層：牌卡 (https://careercreator.tw/counselor1/room1/card1)
第四層：玩法 (https://careercreator.tw/counselor1/room1/card1/play1)
```

**目前 MVP 實作：**

```
# 簡化為單層結構，所有諮詢師共用同一個域名
/room/[roomId]  # 直接房間 ID，內建權限控制
```

**實作差異說明：**

- 目前採用簡化架構，不區分諮詢師子域名
- 權限透過登入狀態和房間創建者來控制
- 牌卡和玩法整合在房間內，不獨立分層

### 核心頁面

#### 1. 諮詢師儀表板 (/dashboard)

- 房間列表（活躍/已結束）
- 新增房間按鈕
- 快速分享連結

#### 2. 諮詢房間 (/room/[roomId])

**三大區塊：**

```
┌─────────────────────────────────┐
│         Navigation Bar          │
│  [返回] [清空] [分享] [參與者]   │
├─────────────────────────────────┤
│                                 │
│     Deck Area (牌組區)          │
│     ┌──┐ ┌──┐ ┌──┐            │
│     │牌│ │牌│ │牌│            │
│     └──┘ └──┘ └──┘            │
│                                 │
├─────────────────────────────────┤
│     Drop Area (放置區)          │
│     已選擇：0/5                 │
│     ________________            │
│                                 │
└─────────────────────────────────┘
```

## 房間管理邏輯

### 房間生命週期

1. **創建**：諮詢師創建，獲得唯一ID
2. **分享**：生成短連結 + QR Code
3. **活躍**：有人在房間內操作
4. **閒置**：無人操作但仍可訪問
5. **過期**：超過有效期（預設7天）

### 權限管理

```javascript
諮詢師（房間創建者）
- 所有操作權限
- 可清空畫面
- 可結束房間

來訪者（透過連結加入）
- 可操作牌卡
- 可查看內容
- 無法刪除房間
```

## 牌卡操作功能

### 三種牌卡玩法（~~MVP選一種~~ 決定全做）

> **技術決策說明**：雖然案主期待先做一種，但考量架構彈性與未來擴展性，我們決定採用**通用規則引擎架構**，一次實現三種玩法規則。每種規則配一套官方牌卡內容，用戶自定義牌卡內容功能留待後續。

#### 1. 職能盤點卡 - 優劣勢分析

- 左側：堆疊牌組
- 右側：兩個區域（優勢5張/劣勢5張）
- 拖曳牌卡到對應區域
- 顯示計數器（如：3/5）

#### 2. 價值導航卡 - 價值觀排序

- 左側：不同價值的牌組（10萬/5萬/1萬）
- 右側：3×3九宮格
- 拖曳排序（第1-9名）
- 每格限放一張

#### 3. 職游旅人卡 - 六大性格分析

**規則概述：**

- **牌組構成**: 解釋卡6張 + 職業卡100張
- **操作區域**: 三列分類區
- **分類標準**: 喜歡 / 中立 / 討厭

**遊戲流程：**

1. **準備階段**: 諮詢師展示6張解釋卡，說明六大性格類型
2. **探索階段**: 來訪者從100張職業卡中選擇並分類
3. **討論階段**: 針對「喜歡」和「討厭」的職業深入對話
4. **總結階段**: 分析性格偏好與職涯方向的關聯

**區域限制：**

- 喜歡區：最多20張
- 中立區：無限制
- 討厭區：最多20張

**UI布局：**

```
┌─────────────────────────────────────────┐
│  解釋卡區 (6張)                          │
│  [R] [I] [A] [S] [E] [C]                │
├─────────────────────────────────────────┤
│  ┌─────────┐   ┌─────────┐   ┌─────────┐│
│  │  喜歡   │   │  中立   │   │  討厭   ││
│  │  😍     │   │  😐     │   │  😤     ││
│  │ (0/20)  │   │  (無限)   │   │ (0/20)  ││
│  └─────────┘   └─────────┘   └─────────┘│
├─────────────────────────────────────────┤
│  職業卡牌組 (100張)                      │
│  [軟體工程師] [醫生] [老師] ...           │
└─────────────────────────────────────────┘
```

### 基礎操作

1. **翻牌**：點擊切換正反面
2. **拖曳**：從牌組拖到放置區
3. **查看**：長按或雙擊查看詳情
4. **註記**：諮詢師可加註解

### 牌卡狀態（詳細需求）

- **正面**：顯示牌卡標題和圖片
- **反面**：顯示牌卡詳細描述
- **檢閱詳情**：彈出詳細資訊視窗
- **dropped**：已放置到目標區域

### 房間區塊結構

#### Deck Area（牌卡區）

- Search/filter 功能
- Action on Card
  - 正面/反面切換
  - 詳情檢視
  - choices 操作
  - hover effect (待定)
- randomized cards 打亂功能
- reorder by drag and drop 重新排序

#### Dropped Area（放置區）

- choice 選擇顯示
- name 標籤
- card limit 限制顯示 (e.g. 0/5 優劣勢分析)
- drop animation/effect 拖放動效

#### Navigation Area（導航區）

- Back 回到牌卡選擇
- 上一步 / 下一步
- 清空畫面 (or 開新房間就好)
- 儲存畫面 (or 開新房間就好 or 諮詢師自行截圖)
- 分享房間連結 (QR code / raw link)

## 資料模型（簡化版）

### User（諮詢師）

```typescript
{
  id: string
  email: string
  name: string
  password: string  // 加密
}
```

### Room（房間）

```typescript
{
  id: string
  counselorId: string
  name: string
  status: 'active' | 'expired'
  shareLink: string
  expiresAt: Date
  createdAt: Date
}
```

### Visitor（來訪者）

```typescript
{
  roomId: string
  nickname: string
  joinedAt: Date
}
```

### CardAction（操作記錄）

```typescript
{
  id: string
  roomId: string
  userId: string
  action: 'flip' | 'move' | 'annotate'
  cardId: string
  timestamp: Date
  data: JSON
}
```

## UI 設計規範

### 色彩系統

- **主色**：#7FC8C8（青綠色）
- **背景**：#F5F5F5（淺灰）
- **強調**：#FF6B6B（警示）
- **成功**：#4CAF50
- **錯誤**：#F44336

### 版面配置

```
┌────────────────────────────────────────┐
│  [返回] 房間標題 [?] [清空] [分享]      │ 56px
├────────────────────────────────────────┤
│                                        │
│  ┌──────────┐        ┌──────────────┐ │
│  │  牌組區   │  ───>  │   放置區     │ │
│  │ (堆疊)   │        │  (格子/列表)  │ │
│  └──────────┘        └──────────────┘ │
│                                        │
│  [搜尋]              計數器：0/5       │
└────────────────────────────────────────┘
```

### 元件尺寸

- **牌卡**：120×180px（桌面）/ 80×120px（手機）
- **按鈕**：最小高度 44px（觸控友善）
- **圓角**：牌卡 12px / 按鈕 8px
- **陰影**：0 4px 6px rgba(0,0,0,0.1)

### 動效時間

- **快速**：200ms（hover）
- **標準**：300ms（轉場）
- **翻牌**：600ms（3D旋轉）

### 響應式斷點

- **手機**：< 768px（單欄）
- **平板**：768-1024px（雙欄）
- **桌面**：> 1024px（雙欄）

## 技術決策（MVP）

### 前端

- Next.js 14（手機優先）
- Tailwind CSS（快速開發）
- @dnd-kit（拖曳功能）
- Zustand（狀態管理）

### 後端

- Next.js API Routes
- PostgreSQL + Prisma
- JWT 認證
- Polling（暫不用 WebSocket）

### 部署

- Vercel（簡單快速）
- PostgreSQL on Supabase

## 第1個月時程

### Week 1：基礎建設

- 專案架設
- 資料庫設計
- 諮詢師註冊/登入
- 基礎 UI 元件

### Week 2：房間系統

- 創建房間
- 房間列表
- 分享連結（QR Code）
- 來訪者進入流程

### Week 3：牌卡功能

- 牌卡展示
- 拖曳操作
- 翻牌功能
- 簡單同步（Polling）

### Week 4：優化部署

- 手機版優化
- 資料儲存
- 測試修正
- 部署上線

## 第1個月：原型設計與核心雛形（詳細需求）

### 目標

完成 Prototype，具備最小可行產品 (MVP)

### 線上牌卡空間的結構

- 建立基本權限（主持人/來訪者）
- 介面與互動雛形
- 建立可操作的互動畫面與 UI 原型 (Figma/前端雛形)
- 基礎滑鼠操作（翻牌、拖曳、選取）

### 牌卡資訊設計

- 單副牌卡 → 支援正反面翻轉顯示
- 基本資料結構（牌卡標題、描述、圖片欄位）

### 資料儲存

- 建立來訪者基本資訊紀錄（姓名、日期、備註）
- 暫存到本地或簡易資料庫

### 交付

Prototype Demo → 可做一次內部測試，收集早期使用者回饋

## 施工現況（2025-09-16 更新）

### ✅ 已完成功能（前端+後端已連接）

#### 用戶系統

- ✅ 諮詢師註冊頁面 (`/register`) - **已連接後端API**
- ✅ 諮詢師登入頁面 (`/login`) - **已連接後端API**
- ✅ Demo帳號快速登入 - **已連接後端API**
- ✅ JWT Token認證機制 - **已實作**

#### 房間系統 (CRUD完成度100%)

- ✅ 儀表板頁面 (`/dashboard`) - **已連接後端API**
- ✅ 創建房間 (Create) - **完整實作**
  - 設定房間名稱、描述、過期時間
  - 自動產生分享碼
- ✅ 查看房間 (Read) - **完整實作**
  - 列表檢視（我的房間）
  - 單一房間詳情
  - 透過分享碼查詢
- ✅ 結束房間 (Close) - **完整實作**
  - Dashboard有結束按鈕
  - 設定is_active = false
- ✅ 更新房間 (Update) - **完整實作**
  - 後端API: `PUT /api/rooms/{id}` ✅
  - 前端API: `roomsAPI.updateRoom()` ✅
  - UI介面: ✅ **編輯對話框 (EditRoomDialog)**
- ✅ 刪除房間 (Delete) - **完整實作**
  - 後端API: `DELETE /api/rooms/{id}` ✅ (軟刪除is_active=false)
  - 前端API: `roomsAPI.deleteRoom()` ✅
  - UI介面: ✅ **刪除對話框 (DeleteRoomDialog)**
  - 資料一致性: ✅ **刷新後已刪除房間不會重現**
- ✅ QR Code生成與分享功能
- ✅ **資料持久化**: 房間資料儲存在PostgreSQL，刷新不會遺失

#### 牌卡功能（三種玩法全部實現）

- ✅ **職能盤點卡** - 優劣勢分析（優勢5張/劣勢5張）
- ✅ **價值導航卡** - 3×3九宮格排序
- ✅ **職游旅人卡** - 三欄分類（喜歡/中立/討厭）
- ✅ 通用規則引擎架構 (GameEngine + RuleFactory)
- ✅ 牌卡翻轉動畫（點擊翻牌）
- ✅ 拖曳功能（@dnd-kit實現）
- ✅ 輔助卡系統（研究型、社交型等6種）
- ⚠️ **未連接後端**: 牌卡操作無法即時同步

#### UI/UX

- ✅ 響應式設計（手機/平板/桌面）
- ✅ 深色模式支援
- ✅ 牌卡3D翻轉效果
- ✅ 拖曳視覺回饋
- ✅ 計數器顯示（如：3/5）

### ⚠️ 部分完成功能

#### API整合（大部分已連接）

- ✅ `/api/auth/login` - 登入 **已連接**
- ✅ `/api/auth/register` - 註冊 **已連接**
- ✅ `/api/rooms/` - 創建房間 **已連接**
- ✅ `/api/rooms/` - 列出房間 **已連接**
- ✅ `/api/rooms/{id}` - 取得房間詳情 **已連接**
- ✅ `/api/rooms/by-code/{code}` - 透過分享碼查詢 **已連接**
- ✅ `/api/rooms/{id}/close` - 結束房間 **已連接**
- ✅ `/api/rooms/{id}` - 更新房間 **完整實作含UI**
- ✅ `/api/rooms/{id}` - 刪除房間 **完整實作含UI**
- ✅ `/api/rooms/{id}/statistics` - 房間統計 **已實作TDD測試**
- ✅ `/api/visitors/*` - 訪客管理 **已連接**
- ✅ JWT Token認證 **已實作**
- ✅ Session管理 **已實作**

### ❌ 未完成功能

#### 即時同步（最重要）

- ❌ **WebSocket即時同步** - 後端有endpoint但前端未串接
- ❌ **牌卡操作記錄** - `/api/card-events/*` 未使用
- ❌ **多人協作** - 無法看到其他人的即時操作
- ❌ **即時通知** - 有人加入/離開房間的通知

### 🔧 技術債務

1. **WebSocket未整合**:
   - 後端WebSocket endpoint已建立
   - 前端未實作WebSocket連線
   - 無法多人即時協作

2. **牌卡操作未記錄**:
   - CardEvent API未使用
   - 操作歷史無法回放
   - 無法生成諮詢報告

3. **測試覆蓋不足**:
   - 缺少單元測試
   - 缺少E2E測試（Playwright已設置但未完整）

## 成功指標

### MVP（第1個月）

- ✅ 可創建房間並分享（**已完成**）
- ⚠️ 可操作牌卡（前端完成，但**無即時同步**）
- ✅ 手機可正常使用（**已完成**）
- ✅ 房間CRUD完整功能（**已完成含編輯刪除**）
- ⚠️ 5位諮詢師測試通過（**基本功能OK，但無即時協作**）

### 未來指標

- 每週活躍房間數 > 50
- 平均諮詢時長 > 30分鐘
- 用戶回訪率 > 60%

## 下一步優先事項

### 🔴 緊急（影響基本功能）

1. **前後端整合**
   - 連接登入/註冊API
   - 實現JWT Token管理
   - 串接房間CRUD操作

2. **WebSocket整合**
   - 建立WebSocket連線
   - 實現牌卡操作即時同步
   - 多人協作功能

3. **資料持久化**
   - 房間狀態儲存至資料庫
   - 牌卡操作歷史記錄
   - 訪客資訊管理

### 🟡 重要（提升體驗）

1. **狀態管理重構**
   - 統一使用Zustand
   - 整合API狀態管理
   - 優化資料流

2. **錯誤處理**
   - API錯誤處理
   - 斷線重連機制
   - 使用者提示優化

### 🟢 次要（未來優化）

1. **測試覆蓋**
   - 單元測試
   - E2E測試
   - 效能測試

2. **進階功能**
   - 報告生成
   - 資料分析
   - AI建議

## 未來發展

### 第2個月

- 多人同時操作
- 資料報告生成
- 多副牌卡支援

### 第3個月

- AI 建議功能
- CRM 整合
- 企業版功能

---

*版本：3.4（房間CRUD完整版）*
*更新：2025-09-17*
*狀態：前端UI完成95%，後端整合85%，房間CRUD 100%，TDD測試覆蓋，WebSocket未實作*

## 總結

### 現況

- **基本功能可用**：登入、註冊、創建房間、牌卡操作都正常
- **資料會持久化**：存在PostgreSQL資料庫，刷新不會消失
- **房間管理**：Create/Read/Update/Delete/Close**完整實作**，包含編輯和刪除UI
- **TDD測試覆蓋**：46項綜合測試覆蓋房間統計、訪客流程、過期邏輯
- **最大問題**：沒有WebSocket，無法多人即時協作
- **次要問題**：
  - 牌卡操作沒有記錄到card_events表（API存在但前端未串接）

### 適用場景

- ✅ **單人使用**：諮詢師自己操作給來訪者看（螢幕分享）
- ✅ **房間管理**：創建、查看、編輯、刪除、結束房間**完整功能**
- ❌ **遠距協作**：來訪者無法看到諮詢師的即時操作
- ❌ **多人同時**：多人操作會互相覆蓋，沒有同步
